

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>dryxMySQL &mdash; PESSTO Marshall 0.6.5 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.6.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="PESSTO Marshall 0.6.5 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>

<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
<a href="../index.html">Dave Young's Python Documentation</a>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">home</a>|&nbsp;</li>
        <li><a href="../search.html">search</a>|&nbsp;</li>

          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/pessto_icon.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for dryxMySQL</h1><div class="highlight"><pre>
<span class="c">#!/usr/local/bin/python</span>
<span class="c"># encoding: utf-8</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">dryxMySQL.py</span>
<span class="sd">- a handful of useful mysql python methods</span>

<span class="sd">Created by David Young on October 8, 2012</span>
<span class="sd">If you have any questions requiring this script please email me: d.r.young@qub.ac.uk</span>

<span class="sd">dryx syntax:</span>
<span class="sd">p&lt;Var&gt; = variable formatted in the way I want it output to file or screen</span>
<span class="sd">xxx = come back here and do some more work</span>

<span class="sd">&quot;&quot;&quot;</span>


<span class="c">#############################################################################################</span>
<span class="c">#                     MAIN PROGRAM - USE FOR DEBUGGING METHODS IN THIS MODULE               #</span>
<span class="c">#############################################################################################</span>
<div class="viewcode-block" id="main"><a class="viewcode-back" href="../dryxMySQL.html#dryxMySQL.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
  <span class="k">pass</span>


<span class="c">## MAIN HOOK ##</span></div>
<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>







<span class="c">#########################################################################</span>
<span class="c"># DATABASE CONNECTOR - GIVEN DICTIONARY (WRITTEN BY KWS - MOD BY DRYX)  #</span>
<span class="c">#########################################################################</span>
<span class="k">def</span> <span class="nf">generate_database_connection</span><span class="p">(</span><span class="n">lhost</span><span class="p">,</span> <span class="n">luser</span><span class="p">,</span> <span class="n">lpasswd</span><span class="p">,</span> <span class="n">ldb</span><span class="p">,</span> <span class="n">quitOnError</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
  <span class="c">#### IMPORTS ####</span>
  <span class="kn">import</span> <span class="nn">MySQLdb</span>
  <span class="kn">import</span> <span class="nn">logging</span>

	<span class="c">#### FUNCTION ####</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;making the &#39;</span><span class="o">+</span><span class="n">ldb</span><span class="o">+</span><span class="s">&#39; database connection on &#39;</span><span class="o">+</span><span class="n">lhost</span><span class="p">)</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span> <span class="p">(</span><span class="n">host</span> <span class="o">=</span> <span class="n">lhost</span><span class="p">,</span>
                              <span class="n">user</span> <span class="o">=</span> <span class="n">luser</span><span class="p">,</span>
                            <span class="n">passwd</span> <span class="o">=</span> <span class="n">lpasswd</span><span class="p">,</span>
                                <span class="n">db</span> <span class="o">=</span> <span class="n">ldb</span><span class="p">)</span>
  <span class="k">except</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;could not make the &#39;</span><span class="o">+</span><span class="n">ldb</span><span class="o">+</span><span class="s">&#39; database connection on &#39;</span><span class="o">+</span><span class="n">lhost</span><span class="p">)</span>
    <span class="c">#print &quot;Error %d: %s&quot; % (e.args[0], e.args[1])</span>

  <span class="k">if</span> <span class="n">quitOnError</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">conn</span><span class="o">=</span><span class="bp">None</span>

  <span class="k">return</span> <span class="n">conn</span>





<span class="c">##########################################################</span>
<span class="c"># DATABASE CONNECTION GIVEN YAML DICTIONARY OF PARAMETERS #</span>
<span class="c">###########################################################</span>
<div class="viewcode-block" id="dbConn"><a class="viewcode-back" href="../something_new.html#dryxMySQL.dbConn">[docs]</a><span class="k">def</span> <span class="nf">dbConn</span><span class="p">(</span><span class="n">pathToYamlFile</span><span class="p">):</span>
  <span class="c">## IMPORTS ##</span>
  <span class="kn">import</span> <span class="nn">logging</span>
  <span class="kn">import</span> <span class="nn">MySQLdb</span> <span class="kn">as</span> <span class="nn">ms</span>
  <span class="kn">import</span> <span class="nn">yaml</span>
  <span class="kn">import</span> <span class="nn">sys</span>


  <span class="c">## IMPORT THE YAML CONNECTION DICTIONARY ##</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;importing the yaml database connection dictionary from &#39;</span><span class="o">+</span><span class="n">pathToYamlFile</span><span class="p">)</span>
    <span class="n">stream</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">pathToYamlFile</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">connDict</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
  <span class="k">except</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;could not load the connect dictionary from &#39;</span><span class="o">+</span><span class="n">pathToYamlFile</span><span class="p">)</span>
      <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

  <span class="c">## ESTABLISH A DB CONNECTION</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;connecting to the &#39;</span><span class="o">+</span><span class="n">connDict</span><span class="p">[</span><span class="s">&#39;db&#39;</span><span class="p">]</span><span class="o">+</span><span class="s">&#39; database on &#39;</span><span class="o">+</span><span class="n">connDict</span><span class="p">[</span><span class="s">&#39;host&#39;</span><span class="p">])</span>
    <span class="n">dbConn</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">connDict</span><span class="p">[</span><span class="s">&#39;host&#39;</span><span class="p">],</span><span class="n">user</span><span class="o">=</span><span class="n">connDict</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">],</span><span class="n">passwd</span><span class="o">=</span><span class="n">connDict</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">],</span><span class="n">db</span><span class="o">=</span><span class="n">connDict</span><span class="p">[</span><span class="s">&#39;db&#39;</span><span class="p">])</span>
  <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;could not connect to the &#39;</span><span class="o">+</span><span class="n">connDict</span><span class="p">[</span><span class="s">&#39;db&#39;</span><span class="p">]</span><span class="o">+</span><span class="s">&#39; database on &#39;</span><span class="o">+</span><span class="n">connDict</span><span class="p">[</span><span class="s">&#39;host&#39;</span><span class="p">]</span><span class="o">+</span><span class="s">&#39; : &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">dbConn</span>






<span class="c">####################################################################################</span>
<span class="c"># EXECUTE A MYSQL WRITE COMMAND GIVEN A QUERY (STRING) AND A DATABASE CONNECTION   #</span>
<span class="c">####################################################################################</span>
<span class="c">## LAST MODIFIED : 20121023</span>
<span class="c">## CREATED : 20121023</span></div>
<div class="viewcode-block" id="executeMySQLWriteCommand"><a class="viewcode-back" href="../something_new.html#dryxMySQL.executeMySQLWriteCommand">[docs]</a><span class="k">def</span> <span class="nf">executeMySQLWriteCommand</span><span class="p">(</span><span class="n">sqlQuery</span><span class="p">,</span><span class="n">dbConn</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Will execute a MySQL write command given a query (string) and a database connection</span>

<span class="sd">      Key Arguuments:</span>
<span class="sd">        - sqlQuery -- the MySQL command to execute</span>
<span class="sd">        - dbConn -- the db connection</span>

<span class="sd">      Returns:</span>
<span class="sd">        - None</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c">## &gt; IMPORTS ##</span>
  <span class="kn">import</span> <span class="nn">MySQLdb</span>
  <span class="kn">import</span> <span class="nn">logging</span>

  <span class="c">###########################################################</span>
  <span class="c"># &gt;ACTION(S)                                              #</span>
  <span class="c">###########################################################</span>
  <span class="sd">&quot;&quot;&quot;create db cursor&quot;&quot;&quot;</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">cursor</span><span class="o">=</span><span class="n">dbConn</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">MySQLdb</span><span class="o">.</span><span class="n">cursors</span><span class="o">.</span><span class="n">DictCursor</span><span class="p">)</span>
  <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;could not create the database cursor.&#39;</span><span class="p">)</span>

  <span class="sd">&quot;&quot;&quot;execute the sql command&quot;&quot;&quot;</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sqlQuery</span><span class="p">)</span>
  <span class="k">except</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1050</span> <span class="ow">and</span> <span class="s">&#39;already exists&#39;</span> <span class="ow">in</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;MySQL write command not executed for this query: &lt;&lt; </span><span class="si">%s</span><span class="s"> &gt;&gt;</span><span class="se">\n</span><span class="s">The error was: </span><span class="si">%s</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sqlQuery</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
  <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;MySQL write command not executed for this query: &lt;&lt; </span><span class="si">%s</span><span class="s"> &gt;&gt;</span><span class="se">\n</span><span class="s">The error was: </span><span class="si">%s</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sqlQuery</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

  <span class="sd">&quot;&quot;&quot;close the cursor&quot;&quot;&quot;</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
  <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;could not close the db cursor &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

  <span class="k">return</span> <span class="bp">None</span>





<span class="c">####################################################################################</span>
<span class="c"># EXECUTE A MYSQL SELECT COMMAND GIVEN A QUERY (STRING) AND A DATABASE CONNECTION  #</span>
<span class="c">####################################################################################</span>
<span class="c">## LAST MODIFIED : 20121023</span>
<span class="c">## CREATED : 20121023</span></div>
<div class="viewcode-block" id="executeMySQLReadCommand"><a class="viewcode-back" href="../something_new.html#dryxMySQL.executeMySQLReadCommand">[docs]</a><span class="k">def</span> <span class="nf">executeMySQLReadCommand</span><span class="p">(</span><span class="n">sqlQuery</span><span class="p">,</span><span class="n">dbConn</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Will execute a MySQL select command given a query (string) and a database connection</span>

<span class="sd">      Key Arguuments:</span>
<span class="sd">        - sqlQuery -- the MySQL command to execute</span>
<span class="sd">        - dbConn -- the db connection</span>

<span class="sd">      Returns:</span>
<span class="sd">        - rows</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c">## &gt; IMPORTS ##</span>
  <span class="kn">import</span> <span class="nn">MySQLdb</span>
  <span class="kn">import</span> <span class="nn">logging</span>

  <span class="c">###########################################################</span>
  <span class="c"># &gt;ACTION(S)                                              #</span>
  <span class="c">###########################################################</span>
  <span class="sd">&quot;&quot;&quot;create db cursor&quot;&quot;&quot;</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">cursor</span><span class="o">=</span><span class="n">dbConn</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">MySQLdb</span><span class="o">.</span><span class="n">cursors</span><span class="o">.</span><span class="n">DictCursor</span><span class="p">)</span>
  <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;could not create the database cursor.&#39;</span><span class="p">)</span>

  <span class="sd">&quot;&quot;&quot;execute the sql command&quot;&quot;&quot;</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sqlQuery</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span>  <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
  <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;MySQL raised an error - write command not executed.</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">e</span>

  <span class="sd">&quot;&quot;&quot;close the cursor&quot;&quot;&quot;</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
  <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;could not close the db cursor &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">rows</span>





<span class="c">########################################################################</span>
<span class="c"># GENERATE &amp; POPULATE A MYSQL TABLE FROM DICTIONARY (WRTITEN BY DRYX)  #</span>
<span class="c">########################################################################</span>
<span class="c">## LAST MODIFIED : 20121023</span>
<span class="c">## CREATED : 20121023</span></div>
<div class="viewcode-block" id="dictionary2MySQLConverter"><a class="viewcode-back" href="../something_new.html#dryxMySQL.dictionary2MySQLConverter">[docs]</a><span class="k">def</span> <span class="nf">dictionary2MySQLConverter</span><span class="p">(</span><span class="n">dbConn</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">,</span> <span class="n">dbTableName</span><span class="p">,</span> <span class="n">uniqueKeyList</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;will take a python dictionary and convert it into a mysql table</span>

<span class="sd">      Key Arguuments:</span>
<span class="sd">        - dictionary -- python dictionary</span>
<span class="sd">        - dbConn -- the db connection</span>
<span class="sd">        - dbTableName -- name of the table you wish to add the data to (or create if it does not exist)</span>
<span class="sd">        - uniqueKeyList - a tuple of lowcase, no space mysql column names that need to be the primary key</span>
<span class="sd">        - extraColumnsDict - a dictionary of column names and default values to be added to db table</span>

<span class="sd">      Returns:</span>
<span class="sd">        - None</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c">## &gt;IMPORTS ##</span>
  <span class="kn">import</span> <span class="nn">MySQLdb</span>
  <span class="kn">import</span> <span class="nn">re</span>
  <span class="kn">import</span> <span class="nn">logging</span>
  <span class="kn">import</span> <span class="nn">yaml</span>
  <span class="kn">import</span> <span class="nn">time</span>
  <span class="kn">import</span> <span class="nn">bcsx_basics_dryx</span>
  <span class="kn">import</span> <span class="nn">ordereddict</span> <span class="kn">as</span> <span class="nn">c</span> <span class="c"># REMOVE WHEN PYTHON @&gt;&amp; INSTALLED ON PSDB</span>
  <span class="c">#import collections as c</span>

  <span class="c">## &gt;SETTINGS ##</span>
  <span class="n">qCreateColumnPreamble</span> <span class="o">=</span> <span class="s">&quot;IF NOT EXISTS( (SELECT * FROM information_schema.COLUMNS WHERE TABLE_SCHEMA=DATABASE() AND COLUMN_NAME=&#39;my_additional_column&#39; AND TABLE_NAME=&#39;my_table_name&#39;) ) THEN&quot;</span>
  <span class="n">qCreateColumnPostamble</span> <span class="o">=</span> <span class="s">&quot;PRIMARY KEY (`primaryId`)) ENGINE=MyISAM AUTO_INCREMENT=0 DEFAULT CHARSET=latin1;</span><span class="se">\n</span><span class="s">SET character_set_client = @saved_cs_client;</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="c"># MySQL DOES NOT LIKE COMPOUNDED QUERIES FROM MYSQLDB - CREATE LIST OF QUERIES INSTEAD</span>
  <span class="n">qCreateTableCommandList</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">qCreateTableCommandList</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&quot;SET @saved_cs_client = @@character_set_client&quot;</span><span class="p">])</span>
  <span class="n">qCreateTableCommandList</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&quot;SET character_set_client = utf8&quot;</span><span class="p">])</span>
  <span class="n">qCreateTableCommandList</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&quot;SET sql_notes = 0&quot;</span><span class="p">])</span>
  <span class="n">qCreateTableCommandList</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&quot;&quot;&quot;CREATE TABLE IF NOT EXISTS `&quot;&quot;&quot;</span><span class="o">+</span><span class="n">dbTableName</span><span class="o">+</span><span class="s">&quot;&quot;&quot;`</span>
<span class="s">                      (`primaryId` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#39;An internal counter&#39;,</span>
<span class="s">                      PRIMARY KEY (`primaryId`))</span>
<span class="s">                      ENGINE=MyISAM AUTO_INCREMENT=0 DEFAULT CHARSET=latin1&quot;&quot;&quot;</span><span class="p">])</span>
  <span class="n">qCreateTableCommandList</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&quot;SET @@character_set_client = @saved_cs_client&quot;</span><span class="p">])</span>
  <span class="n">qCreateTableCommandList</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&quot;SET sql_notes = 1&quot;</span><span class="p">])</span>

  <span class="n">reFeedParserClass</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;FeedParserDict&#39;</span><span class="p">)</span>
  <span class="n">reDatetime</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;^[0-9]{4}-[0-9]{2}-[0-9]{2}T&#39;</span><span class="p">)</span>
  <span class="n">reTypeTime</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;struct_time&#39;</span><span class="p">)</span>

  <span class="n">qCreateColumn</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
  <span class="n">formattedKey</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
  <span class="n">formattedKeyList</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">myValues</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="c">###########################################################</span>
  <span class="c"># &gt;ACTIONS                                                #</span>
  <span class="c">###########################################################</span>
  <span class="c"># CREATE THE TABLE IF IT DOES NOT EXIST YET</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="c">#logging.debug(&quot;creating the &quot;+dbTableName+&quot; table if it does not exist&quot;)</span>
    <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">qCreateTableCommandList</span><span class="p">:</span>
      <span class="n">executeMySQLWriteCommand</span><span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="n">dbConn</span><span class="p">)</span>
  <span class="k">except</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1050</span> <span class="ow">and</span> <span class="s">&#39;already exists&#39;</span> <span class="ow">in</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
      <span class="c"># MYSQL WARNING</span>
      <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">critial</span><span class="p">(</span><span class="s">&quot;could not create the table &quot;</span><span class="o">+</span><span class="n">dbTableName</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
      <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
  <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&quot;could not create the table &quot;</span><span class="o">+</span><span class="n">dbTableName</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

  <span class="c"># ADD EXTRA COLUMNS TO THE DICTIONARY</span>
  <span class="n">dictionary</span><span class="p">[</span><span class="s">&#39;dateCreated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bcsx_basics_dryx</span><span class="o">.</span><span class="n">nowDateTimeStamp</span><span class="p">())</span>
  <span class="n">dictionary</span><span class="p">[</span><span class="s">&#39;dateLastModified&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bcsx_basics_dryx</span><span class="o">.</span><span class="n">nowDateTimeStamp</span><span class="p">())</span>
  <span class="n">dictionary</span><span class="p">[</span><span class="s">&#39;dateLastRead&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bcsx_basics_dryx</span><span class="o">.</span><span class="n">nowDateTimeStamp</span><span class="p">())</span>

  <span class="c"># ITERATE THROUGH THE DICTIONARY AND GENERATE THE A TABLE COLUMN WITH THE NAME OF THE KEY, IF IT DOES NOT EXIST</span>
  <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)</span>
  <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>

  <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span><span class="p">(</span><span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
      <span class="k">del</span> <span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

  <span class="c"># SORT THE DICTIONARY BY KEY</span>
  <span class="n">odictionary</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
  <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">odictionary</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>

    <span class="n">formattedKey</span> <span class="o">=</span> <span class="n">key</span>
    <span class="c"># DEC A KEYWORD IN MYSQL - NEED TO CHANGE BEFORE INGEST</span>
    <span class="k">if</span><span class="p">(</span><span class="n">formattedKey</span> <span class="o">==</span> <span class="s">&#39;dec&#39;</span><span class="p">):</span>
      <span class="n">formattedKey</span> <span class="o">=</span> <span class="s">&#39;decl&#39;</span>
    <span class="n">formattedKeyList</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">formattedKey</span><span class="p">])</span>

    <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
      <span class="c"># CONVERT LIST AND FEEDPARSER VALUES TO YAML (SO I CAN PASS IT AS A STRING TO MYSQL)</span>
      <span class="k">if</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">or</span> <span class="n">reFeedParserClass</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)))):</span>
        <span class="n">value</span> <span class="o">=</span>  <span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

      <span class="c"># REMOVE CHARACTERS THAT COLLIDE WITH MYSQL</span>
      <span class="k">if</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">unicode</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span><span class="s">&quot;&#39;&quot;</span><span class="p">)</span>

      <span class="c"># JOIN THE VALUES TOGETHER IN A LIST - EASIER TO GENERATE THE MYSQL COMMAND LATER</span>
      <span class="k">if</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">unicode</span><span class="p">):</span>
        <span class="n">myValues</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">())])</span>
      <span class="k">else</span><span class="p">:</span> <span class="n">myValues</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,)])</span>

      <span class="c"># CHECK IF COLUMN EXISTS YET</span>
      <span class="n">colExists</span> <span class="o">=</span> <span class="s">&quot;SELECT *</span><span class="se">\</span>
<span class="s">                FROM information_schema.COLUMNS</span><span class="se">\</span>
<span class="s">                WHERE TABLE_SCHEMA=DATABASE()</span><span class="se">\</span>
<span class="s">                  AND COLUMN_NAME=&#39;&quot;</span><span class="o">+</span><span class="n">formattedKey</span><span class="o">+</span><span class="s">&quot;&#39;</span><span class="se">\</span>
<span class="s">                  AND TABLE_NAME=&#39;&quot;</span><span class="o">+</span><span class="n">dbTableName</span><span class="o">+</span><span class="s">&quot;&#39;&quot;</span>

      <span class="k">try</span><span class="p">:</span>
        <span class="c">#logging.debug(&#39;checking if the column &#39;+formattedKey+&#39; exists in the &#39;+dbTableName+&#39; table&#39;)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">executeMySQLReadCommand</span><span class="p">(</span><span class="n">colExists</span><span class="p">,</span><span class="n">dbConn</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;something went wrong&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

      <span class="c"># IF COLUMN DOESN&#39;T EXIT - GENERATE IT</span>
      <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">qCreateColumn</span> <span class="o">=</span> <span class="s">&quot;ALTER TABLE &quot;</span><span class="o">+</span><span class="n">dbTableName</span><span class="o">+</span><span class="s">&quot; ADD &quot;</span><span class="o">+</span><span class="n">formattedKey</span>
        <span class="k">if</span><span class="p">(</span><span class="n">reDatetime</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))):</span>
          <span class="c">#logging.debug(&#39;Ok - a datetime string was found&#39;)</span>
          <span class="n">qCreateColumn</span> <span class="o">+=</span> <span class="s">&quot; datetime DEFAULT NULL&quot;</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">formattedKey</span> <span class="o">==</span> <span class="s">&#39;updated_parsed&#39;</span> <span class="ow">or</span> <span class="n">formattedKey</span> <span class="o">==</span> <span class="s">&#39;published_parsed&#39;</span> <span class="ow">or</span> <span class="n">formattedKey</span> <span class="o">==</span> <span class="s">&#39;feedName&#39;</span> <span class="ow">or</span> <span class="n">formattedKey</span> <span class="o">==</span> <span class="s">&#39;title&#39;</span><span class="p">):</span>
          <span class="n">qCreateColumn</span> <span class="o">+=</span> <span class="s">&quot; varchar(200) DEFAULT NULL&quot;</span>
        <span class="k">elif</span><span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">unicode</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">):</span>
          <span class="n">qCreateColumn</span> <span class="o">+=</span> <span class="s">&quot; varchar(450) DEFAULT NULL&quot;</span>
        <span class="k">elif</span><span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">unicode</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">30</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">):</span>
          <span class="n">qCreateColumn</span> <span class="o">+=</span> <span class="s">&quot; varchar(450) DEFAULT NULL&quot;</span>
        <span class="k">elif</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">unicode</span><span class="p">):</span>
          <span class="n">columnLength</span> <span class="o">=</span> <span class="mi">450</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
          <span class="n">qCreateColumn</span> <span class="o">+=</span> <span class="s">&quot; varchar(&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">columnLength</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;) DEFAULT NULL&quot;</span>
        <span class="k">elif</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">9</span><span class="p">):</span>
          <span class="n">qCreateColumn</span> <span class="o">+=</span> <span class="s">&quot; tinyint DEFAULT NULL&quot;</span>
        <span class="k">elif</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">):</span>
          <span class="n">qCreateColumn</span> <span class="o">+=</span> <span class="s">&quot; int DEFAULT NULL&quot;</span>
        <span class="k">elif</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">long</span><span class="p">):</span>
          <span class="n">qCreateColumn</span> <span class="o">+=</span> <span class="s">&quot; double DEFAULT NULL&quot;</span>
        <span class="k">elif</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">):</span>
          <span class="n">qCreateColumn</span> <span class="o">+=</span> <span class="s">&quot; tinyint DEFAULT NULL&quot;</span>
        <span class="k">elif</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">):</span>
          <span class="n">qCreateColumn</span> <span class="o">+=</span> <span class="s">&quot; varchar(1024) DEFAULT NULL&quot;</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Do not know what format to add this key in MySQL - removing from dictionary: </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
          <span class="n">formattedKeyList</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
          <span class="n">myValues</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
          <span class="n">qCreateColumn</span> <span class="o">=</span> <span class="bp">None</span>



        <span class="k">if</span> <span class="n">qCreateColumn</span><span class="p">:</span>
          <span class="c">## ADD COMMENT TO GIVE THE ORGINAL KEYWORD IF formatted FOR MYSQL</span>
          <span class="k">if</span><span class="p">(</span><span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">formattedKey</span><span class="p">):</span>
            <span class="n">qCreateColumn</span> <span class="o">+=</span> <span class="s">&quot; COMMENT &#39;original keyword: &quot;</span><span class="o">+</span><span class="n">key</span><span class="o">+</span><span class="s">&quot;&#39;&quot;</span>

          <span class="c">## CREATE THE COLUMN IF IT DOES NOT EXIST</span>
          <span class="k">try</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;creating the &quot;</span><span class="o">+</span><span class="n">formattedKey</span><span class="o">+</span><span class="s">&quot; column in the &quot;</span><span class="o">+</span><span class="n">dbTableName</span><span class="o">+</span><span class="s">&quot; table&quot;</span><span class="p">)</span>
            <span class="n">executeMySQLWriteCommand</span><span class="p">(</span><span class="n">qCreateColumn</span><span class="p">,</span><span class="n">dbConn</span><span class="p">)</span>
          <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;qCreateColumn: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qCreateColumn</span><span class="p">,))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;could not create the &quot;</span><span class="o">+</span><span class="n">formattedKey</span><span class="o">+</span><span class="s">&quot; column in the &quot;</span><span class="o">+</span><span class="n">dbTableName</span><span class="o">+</span><span class="s">&quot; table -- &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>


  <span class="c">## GENERATE THE INDEX NAME - THEN CREATE INDEX IF IT DOES NOT YET EXIST</span>
  <span class="c"># CHECK IF THE UNIQUE KEY IS A LIST (COULD BE STRING)</span>
  <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">uniqueKeyList</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
      <span class="n">indexName</span> <span class="o">=</span> <span class="n">uniqueKeyList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">uniqueKeyList</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
          <span class="n">indexName</span> <span class="o">+=</span> <span class="s">&quot;_&quot;</span><span class="o">+</span><span class="n">uniqueKeyList</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
  <span class="k">else</span><span class="p">:</span> <span class="n">indexName</span> <span class="o">=</span> <span class="n">uniqueKeyList</span>
  <span class="n">indexName</span> <span class="o">=</span> <span class="n">bcsx_basics_dryx</span><span class="o">.</span><span class="n">make_lowercase_nospace</span><span class="p">(</span><span class="n">indexName</span><span class="p">)</span>
  <span class="n">rows</span> <span class="o">=</span> <span class="n">executeMySQLReadCommand</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT COUNT(*) FROM INFORMATION_SCHEMA.STATISTICS WHERE TABLE_SCHEMA = DATABASE() AND</span>
<span class="s">                TABLE_NAME = &#39;&quot;&quot;&quot;</span><span class="o">+</span><span class="n">dbTableName</span><span class="o">+</span><span class="s">&quot;&quot;&quot;&#39; AND INDEX_NAME = &#39;&quot;&quot;&quot;</span><span class="o">+</span><span class="n">indexName</span><span class="o">+</span><span class="s">&quot;&quot;&quot;&#39;&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">dbConn</span><span class="p">)</span>

  <span class="n">exists</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;COUNT(*)&#39;</span><span class="p">]</span>
  <span class="k">if</span><span class="p">(</span><span class="n">exists</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">uniqueKeyList</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
      <span class="n">uniqueKeyList</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">uniqueKeyList</span><span class="p">)</span>

    <span class="n">addUniqueKey</span> <span class="o">=</span> <span class="s">&quot;ALTER TABLE &quot;</span><span class="o">+</span><span class="n">dbTableName</span><span class="o">+</span><span class="s">&quot; ADD unique &quot;</span><span class="o">+</span><span class="n">indexName</span><span class="o">+</span><span class="s">&quot; (&quot;</span><span class="o">+</span><span class="n">uniqueKeyList</span><span class="o">+</span><span class="s">&quot;)&quot;</span>
    <span class="c">#logging.debug(&#39;HERE IS THE COMMAND:&#39;+addUniqueKey)</span>
    <span class="n">executeMySQLWriteCommand</span><span class="p">(</span><span class="n">addUniqueKey</span><span class="p">,</span><span class="n">dbConn</span><span class="p">)</span>

  <span class="c"># GENERATE THE INSERT COMMAND - IGNORE DUPLICATE ENTRIES</span>
  <span class="n">myKeys</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">formattedKeyList</span><span class="p">)</span>
  <span class="n">myValues</span> <span class="o">=</span> <span class="s">&#39;&quot; ,&quot;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">myValues</span><span class="p">)</span>
  <span class="c">#logging.debug(myValues+&quot; ------ PRESTRIP&quot;)</span>
  <span class="c"># REMOVE SOME CONVERSION NOISE</span>
  <span class="n">myValues</span> <span class="o">=</span><span class="n">myValues</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;time.struct_time&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
  <span class="n">myValues</span> <span class="o">=</span><span class="n">myValues</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;- !!python/object/new:feedparser.FeedParserDict&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
  <span class="n">myValues</span> <span class="o">=</span><span class="n">myValues</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;!!python/object/new:feedparser.FeedParserDict&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
  <span class="n">myValues</span> <span class="o">=</span><span class="n">myValues</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;dictitems:&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
  <span class="n">myValues</span> <span class="o">=</span><span class="n">myValues</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;dictitems&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
  <span class="n">myValues</span> <span class="o">=</span><span class="n">myValues</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;!!python/unicode:&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
  <span class="n">myValues</span> <span class="o">=</span><span class="n">myValues</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;!!python/unicode&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>

  <span class="c">#logging.debug(myValues+&quot; ------ POSTSTRIP&quot;)</span>
  <span class="n">addValue</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;INSERT IGNORE INTO &quot;&quot;&quot;</span><span class="o">+</span><span class="n">dbTableName</span><span class="o">+</span><span class="s">&quot;&quot;&quot; (&quot;&quot;&quot;</span><span class="o">+</span><span class="n">myKeys</span><span class="o">+</span><span class="s">&quot;&quot;&quot;) VALUES (</span><span class="se">\&quot;</span><span class="s">&quot;&quot;&quot;</span><span class="o">+</span><span class="n">myValues</span><span class="o">+</span><span class="s">&quot;&quot;&quot;</span><span class="se">\&quot;</span><span class="s">)&quot;&quot;&quot;</span>
  <span class="c">#logging.debug(addValue)</span>

  <span class="k">try</span><span class="p">:</span>
    <span class="c">#logging.debug(&quot;checking the table &#39;&quot;+dbTableName+&quot;&#39; for any new data that needs appended&quot;)</span>
    <span class="n">executeMySQLWriteCommand</span><span class="p">(</span><span class="n">addValue</span><span class="p">,</span><span class="n">dbConn</span><span class="p">)</span>
  <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;could not add new data added to the table &#39;&quot;</span><span class="o">+</span><span class="n">dbTableName</span><span class="o">+</span><span class="s">&quot;&#39; : &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

  <span class="k">return</span> <span class="bp">None</span>


<span class="c">########################################################################</span>
<span class="c">#  FUNCTION TO SET A FLAG TO A GIVEN VALUE          (WRTITEN BY DRYX)  #</span>
<span class="c">########################################################################</span>
<span class="c">## LAST MODIFIED : 20121105</span>
<span class="c">## CREATED : 20121105</span></div>
<div class="viewcode-block" id="set_flag"><a class="viewcode-back" href="../dryxMySQL.html#dryxMySQL.set_flag">[docs]</a><span class="k">def</span> <span class="nf">set_flag</span><span class="p">(</span><span class="n">dbConn</span><span class="p">,</span><span class="n">tableName</span><span class="p">,</span><span class="n">flagColumn</span><span class="p">,</span><span class="n">flagValue</span><span class="p">,</span> <span class="n">primaryKeyColumn</span><span class="p">,</span> <span class="n">primaryKeyId</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Function to set a flag to a given value</span>

<span class="sd">      Key Arguuments:</span>
<span class="sd">        - dbConn -- db connection</span>
<span class="sd">        - tableName -- db table name</span>
<span class="sd">        - flagColumn -- flag column name</span>
<span class="sd">        - flagValue -- value flag is to be set to</span>
<span class="sd">        - primaryKeyColumn -- primaryKey column name</span>
<span class="sd">        - primaryKeyId -- single id of the row you wish to set the flag for</span>

<span class="sd">      Returns</span>
<span class="sd">        - None</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c">## &gt; IMPORTS ##</span>
  <span class="kn">import</span> <span class="nn">logging</span>
  <span class="kn">import</span> <span class="nn">dryxMySQL</span> <span class="kn">as</span> <span class="nn">m</span>

  <span class="c">## &gt;SETTINGS ##</span>

  <span class="c">###########################################################</span>
  <span class="c"># &gt;ACTION(S)                                              #</span>
  <span class="c">###########################################################</span>
  <span class="c"># CREATE THE MYSQL COMMAND TO UPDATE FLAG</span>
  <span class="n">sqlQuery</span> <span class="o">=</span> <span class="s">&quot;update &quot;</span><span class="o">+</span><span class="n">tableName</span><span class="o">+</span><span class="s">&quot; set &quot;</span><span class="o">+</span><span class="n">flagColumn</span><span class="o">+</span><span class="s">&quot; = &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">flagValue</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; where &quot;</span><span class="o">+</span><span class="n">primaryKeyColumn</span><span class="o">+</span><span class="s">&quot; = &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">primaryKeyId</span><span class="p">)</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;update the ingested flags for &quot;</span><span class="o">+</span><span class="n">tableName</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">executeMySQLWriteCommand</span><span class="p">(</span><span class="n">sqlQuery</span><span class="p">,</span><span class="n">dbConn</span><span class="p">)</span>
  <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">myError</span> <span class="o">=</span> <span class="s">&quot;could not update the ingested flags for &quot;</span><span class="o">+</span><span class="n">tableName</span><span class="o">+</span><span class="s">&quot;: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">myError</span><span class="p">)</span>

  <span class="k">return</span> <span class="bp">None</span>

<span class="c">######################################################################################################################</span>
<span class="c">## LAST MODIFIED : November 23, 2012</span>
<span class="c">## CREATED : November 23, 2012</span>
<span class="c">## AUTHOR : DRYX</span></div>
<div class="viewcode-block" id="add_column_to_db_table"><a class="viewcode-back" href="../dryxMySQL.html#dryxMySQL.add_column_to_db_table">[docs]</a><span class="k">def</span> <span class="nf">add_column_to_db_table</span><span class="p">(</span><span class="n">tableName</span><span class="p">,</span><span class="n">colName</span><span class="p">,</span><span class="n">colType</span><span class="p">,</span><span class="n">dbConn</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;give the name of the database table, this function will add a column with the given name</span>

<span class="sd">      Key Arguuments:</span>
<span class="sd">        - tableName -- name of table to add column to</span>
<span class="sd">        - dbConn -- database hosting the above table</span>
<span class="sd">        - colName -- name of the column to add</span>
<span class="sd">        - colType -- type of the column to be added</span>
<span class="sd">        - default -- the default value of the column to be added</span>

<span class="sd">      Returns</span>
<span class="sd">        - None</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c">################ &gt; IMPORTS ################</span>
  <span class="kn">import</span> <span class="nn">logging</span>

  <span class="c">################ &gt;SETTINGS ################</span>


  <span class="c">################ &gt;ACTION(S) ################</span>
  <span class="n">colsToAdd</span> <span class="o">=</span> <span class="p">{</span><span class="n">colName</span><span class="p">:</span><span class="n">colType</span><span class="p">}</span>

  <span class="c"># CHECK IF COLUMN EXISTS YET - IF NOT CREATE IT</span>
  <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">colsToAdd</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">colExists</span> <span class="o">=</span> <span class="s">&quot;SELECT *</span><span class="se">\</span>
<span class="s">                FROM information_schema.COLUMNS</span><span class="se">\</span>
<span class="s">                WHERE TABLE_SCHEMA=DATABASE()</span><span class="se">\</span>
<span class="s">                  AND COLUMN_NAME=&#39;&quot;</span><span class="o">+</span><span class="n">key</span><span class="o">+</span><span class="s">&quot;&#39;</span><span class="se">\</span>
<span class="s">                  AND TABLE_NAME=&#39;&quot;</span><span class="o">+</span><span class="n">tableName</span><span class="o">+</span><span class="s">&quot;&#39;&quot;</span>
    <span class="n">colExists</span> <span class="o">=</span> <span class="n">executeMySQLReadCommand</span><span class="p">(</span><span class="n">colExists</span><span class="p">,</span><span class="n">dbConn</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">colExists</span><span class="p">:</span>
        <span class="n">sqlQuery</span> <span class="o">=</span> <span class="s">&quot;ALTER TABLE &quot;</span><span class="o">+</span><span class="n">tableName</span><span class="o">+</span><span class="s">&quot; ADD &quot;</span><span class="o">+</span><span class="n">key</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="n">colsToAdd</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">+</span><span class="s">&quot; DEFAULT NULL&quot;</span>
        <span class="n">executeMySQLWriteCommand</span><span class="p">(</span><span class="n">sqlQuery</span><span class="p">,</span><span class="n">dbConn</span><span class="p">)</span>

  <span class="k">return</span> <span class="bp">None</span>
</pre></div></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">home</a>|&nbsp;</li>
        <li><a href="../search.html">search</a>|&nbsp;</li>

          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      Last updated on Mar 28, 2013.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>