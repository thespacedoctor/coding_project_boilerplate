// WAIT FOR WINDOW TO LOAD AND THEN ADD ALL THE EVENT LISTENERS FOR THE PAGE
function doFirst(){$(".pmTopNavBar").addClass("pmTopNavBar_slideDown");$(".pmLeftNavBar").addClass("pmLeftNavBar_slideIn");$("#bigWrapper").animate({opacity:1},500);$("button#expandButton").click(expand_collapse_object_ticket);$("button#newCommentButton").click(expand_collapse_comment_form);$("form#objectCommentForm").find("button#add").click(add_object_comment);$("form#objectCommentForm").find("button#cancel").click(expand_collapse_comment_form);$("button#addClassificationButton").click(reveal_classification_form);$("div.moveMenuButton").click(moveObjectAndHideRow);$("div.alertMenuButton").click(alertObjectAndHideRow);$('div[id$="Hover"]').mouseover(revealDropDownMenu);$('div[id$="Menu"]').mouseout(hideDropDownMenu);$("button#createNew").click(reveal_create_new_form);$('input[name="sortInput"]').focus(sortFormValidation);$('input[name="searchInput"]').focus(searchFormValidation);var e=$(document).find("div.wfTableRow"),t=e.length;for(var n=0;n<t;n++){columnWrapper=$(e[n]).find(".columnWrapper");var r=columnWrapper.height();columnWrapper.css("height","auto");var i=columnWrapper.height();columnWrapper.height(r);if(i>r){var s=$(e[n]).find("#expandButton");$(s).html('<span class="icon-enlarge"></span>')}}/localpessto/.test(window.location.href)?$("#marshallVersion").text("---- MAC MARSHALL ----"):/sandbox/.test(window.location.href)?$("#marshallVersion").text("---- SANDBOX - DEMO PAGES ----"):/pesstobranch/.test(window.location.href)&&$("#marshallVersion").text("---- MAC SANDBOX ----");var o=window.location.pathname,u=$("a#previousLink"),a=$("a#nextLink"),f=$("select#ticketsperpage"),l=$(document).find("a.objectNameLink"),t=l.length;for(var n=0;n<t;n++)if($(l[n]).text().length>20){var c=160/$(l[n]).text().length,c=Math.round(c)/10;$(l[n]).css("font-size",c+"em")}}function expand_collapse_object_ticket(){var e=$(this).closest(".wfTableRow").attr("poid"),t=$(this).closest(".wfTableRow").find(".columnWrapper"),n=$(this).closest(".wfTableRow").find("#expandButton"),r=t.height();t.css("height","auto");var i=t.height();t.height(r);i<r&&(i=r);if(/enlarge/.test(n.html())){$(".columnWrapper").animate({height:r},300);t.animate({height:i},300);n.html('<span class="icon-contract"></span>')}else{n.html('<span class="icon-enlarge"></span>');var i=t.height();t.removeAttr("style");var r=t.height();t.height(i).animate({height:r},300)}}function expand_collapse_comment_form(){event.preventDefault();var e=$(this).closest(".wfTableRow").find("form#objectCommentForm"),t=$(this).closest(".wfTableRow").attr("poid"),n=e.css("display"),r=$(this).closest(".wfTableRow").find(".columnWrapper");if(n=="none"){$("form#objectCommentForm").slideUp(300);e.slideDown(600)}else e.slideUp(300)}function reveal_classification_form(){var e=$(this).attr("poid"),t=$('#classificationForm[poid="'+e+'"]'),n=$(t).closest(".floatingFormWindow"),r=n.find("div.formError");n.find("button#cancel").click(clear_form_and_return);n.find("select#source").change(function(){$(this).val()==="atel"|$(this).val()==="cbet"?n.find('input[name="number"]').animate({opacity:1},300):n.find('input[name="number"]').animate({opacity:0},300)});n.find('input[name="number"]').focus(function(){$(this).bind("keyup change",function(){var e=n.find('input[name="number"]').val();check_form_input(/^[0-9]{4}$/,$(this),e,r,"atel/cbet number must be exactly 4 digits long")})});n.find('input[name="mjd"]').focus(function(){$(this).bind("keyup change",function(){var e=n.find('input[name="mjd"]').val();check_form_input(/^[0-9\.]{5,12}$/,$(this),e,r,"mjd not in correct format yet")})});n.find('input[name="telescope"]').focus(function(){$(this).bind("keyup change",function(){var e=n.find('input[name="telescope"]').val();check_form_input(/.{2,}$/,$(this),e,r,"use 2 or more characters for the telescope name")})});n.find('input[name="instrument"]').focus(function(){$(this).bind("keyup change",function(){var e=n.find('input[name="instrument"]').val();check_form_input(/.{2,}$/,$(this),e,r,"use 2 or more characters for the instrument name")})});n.find("select#type").change(function(){if($(this).val()!="supernova"){n.find("select#classification").animate({opacity:0},300);n.find("div#classification").animate({opacity:0},300);n.find("div#peculiar").animate({opacity:0},300);n.find("input#peculiar").animate({opacity:0},300)}else{n.find("select#classification").animate({opacity:1},300);n.find("div#classification").animate({opacity:1},300);n.find("div#peculiar").animate({opacity:1},300);n.find("input#peculiar").animate({opacity:1},300)}if($(this).val()=="variable star"){n.find('input[name="redshift"]').animate({opacity:0},300);n.find("div#redshift").animate({opacity:0},300)}else{n.find('input[name="redshift"]').animate({opacity:1},300);n.find("div#redshift").animate({opacity:1},300)}});n.find('input[name="redshift"]').focus(function(){$(this).bind("keyup change",function(){var e=n.find('input[name="redshift"]').val();check_form_input(/^([0-9]\.[0-9]{1,7}$)|$^/,$(this),e,r,"redshift not in the correct format yet")})});n.find('input[name="reducer"]').focus(function(){$(this).bind("keyup change",function(){var e=n.find('input[name="reducer"]').val();check_form_input(/^([A-Za-z\s]{2,40}$)|$^/,$(this),e,r,"please enter more than 2 characters")})});center(t);n.fadeIn(200);t.slideToggle(400);n.find('button[id*="classify"]').click(function(){event.preventDefault();var i=0,s="",o=!1,u=e,s=s+"pesstoObjectsId="+u,a=n.find("div#objectName").text(),s=s+"&objectName="+a,f=n.find("select#source").val(),s=s+"&source="+f;$(this).attr("id")=="justclassify"&&(awfFlag="archived%20without%20alert");$(this).attr("id")=="classify&sendtoalertqueue"&&(awfFlag="queued%20for%20alert");if(f=="atel")var l=n.find('input[name="number"]').val(),i=i+!/^[0-9]{4}$/.test(l),s=s+"&atelNumber="+l,s=s+"&cbetNumber=NULL";else if(f=="cbet")var c=n.find('input[name="number"]').val(),i=i+!/^[0-9]{4}$/.test(c),s=s+"&cbetNumber="+c,s=s+"&atelNumber=NULL";else var s=s+"&atelNumber=NULL",s=s+"&cbetNumber=NULL";var h=n.find('input[name="mjd"]').val(),i=i+!/^[0-9\.]{5,12}$/.test(h),s=s+"&mjd="+h,p=n.find('input[name="telescope"]').val(),i=i+!/.{2,}$/.test(p),s=s+"&telescope="+p,d=n.find('input[name="instrument"]').val(),i=i+!/.{2,}$/.test(d),s=s+"&instrument="+d,v=n.find("select#type").val(),s=s+"&type="+v;if(v=="supernova"){var m=n.find("select#classification").val();n.find("input#peculiar").is(":checked")&&(m+=" peculiar")}else var m="NULL";var s=s+"&classification="+m,g=n.find('input[name="redshift"]').val(),i=i+!/^([0-9]\.[0-9]{1,7}$)|$^/.test(g),s=s+"&redshift="+g,y=n.find('input[name="reducer"]').val(),i=i+!/^([A-Za-z\s]{2,40}$)|$^/.test(y),s=s+"&reducer="+y,s="button=classify_object&"+s+"&awfFlag="+awfFlag+"&mwfFlag=review%20for%20followup";if(i==0){var b="../scripts/pesstoMarshallButtons.py?"+s;$.getJSON(b,function(e){});pause(20);t.slideToggle(200);n.fadeOut(400);var o=!0;return!0}event.preventDefault();r.css("color","#dc322f");r.text("there's an error in this form").show().fadeIn(300)})}function clear_form_and_return(){event.preventDefault();var e=$(this).closest("form");thisWindow=$(this).closest(".floatingFormWindow");var t=e.find("input");e.slideToggle(200);thisWindow.fadeOut(400)}function reveal_create_new_form(){var e=$("form#createNewObjectForm"),t=e.closest(".floatingFormWindow");center(e);t.find("button#cancel").click(clear_form_and_return);t.fadeIn(200);e.slideToggle(400);var n=t.find("div.formError");t.find('input[name="objectName"]').focus(function(){$(this).bind("keyup change",function(){thisValue=t.find('input[name="objectName"]').val();check_form_input(/\w{6,100}/,$(this),thisValue,n,"object name must be 6 characters or longer")})});t.find('input[name="survey"]').focus(function(){$(this).bind("keyup change",function(){thisValue=t.find('input[name="survey"]').val();check_form_input(/\w{3,20}/,$(this),thisValue,n,"survey name must be 3 characters or longer")})});t.find('input[name="objectUrl"]').focus(function(){$(this).bind("keyup change",function(){thisValue=t.find('input[name="objectUrl"]').val();var e=/[-a-zA-Z0-9@:%_\+.~#?&//=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&//=]*)?|$^/gi;check_form_input(e,$(this),thisValue,n,"please enter a valid source url for the object")})});t.find('input[name="objectImageUrl"]').focus(function(){$(this).bind("keyup change",function(){thisValue=t.find('input[name="objectImageUrl"]').val();var e=/[-a-zA-Z0-9@:%_\+.~#?&//=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&//=]*)?|$^/gi;check_form_input(e,$(this),thisValue,n,"please enter a valid url for an image of the object")})});t.find('input[name="ra"]').focus(function(){$(this).bind("keyup change",function(){thisValue=t.find('input[name="ra"]').val();thisValue<360&thisValue>0?check_form_input(/^\+?\d{1,3}\.\d{1,}$/,$(this),thisValue,n,"please enter RA in degrees or sexagesimal format"):check_form_input(/^\+?([0-9]|([0-1][0-9])|([2][0-3]))(:| )[0-5][0-9](:| )[0-5][0-9]((\.\d{1,})?)$/,$(this),thisValue,n,"RA in degrees or sexagesimal format")});$(this).bind("blur",function(){ra=t.find('input[name="ra"]');thisValue=ra.val();/^\+?([0-9]|([0-1][0-9])|([2][0-3]))(:| )[0-5][0-9](:| )[0-5][0-9]((\.\d{1,})?)$/.test(thisValue)&&ra.val(ra_sex2degrees(thisValue))})});t.find('input[name="dec"]').focus(function(){$(this).bind("keyup change",function(){thisValue=t.find('input[name="dec"]').val();thisValue<90&thisValue>-90?check_form_input(/^[\-\+]?\d{1,3}\.\d{1,}$/,$(this),thisValue,n,"please enter DEC in degrees or sexagesimal format"):check_form_input(/^([\+\-]?([0-9]|[0-8][0-9]))(:| )[0-5][0-9](:| )[0-5][0-9](\.\d{1,})?$/,$(this),thisValue,n,"DEC in degrees or sexagesimal format")});$(this).bind("blur",function(){dec=t.find('input[name="dec"]');thisValue=dec.val();/^([\+\-]?([0-9]|[0-8][0-9]))(:| )[0-5][0-9](:| )[0-5][0-9](\.\d{1,})?$/.test(thisValue)&&dec.val(dec_sex2degrees(thisValue))})});t.find('input[name="discoveryMag"]').focus(function(){$(this).bind("keyup change",function(){thisValue=t.find('input[name="discoveryMag"]').val();check_form_input(/^\d{1,2}\.\d{1,3}/,$(this),thisValue,n,"please enter a valid magnitude")})});t.find('input[name="discoveryFilter"]').focus(function(){$(this).bind("keyup change",function(){var e=t.find('input[name="discoveryFilter"]').val();check_form_input(/^\w{1,7}/,$(this),e,n,"please enter a 1-7 characters")})});t.find('input[name="mjd"]').focus(function(){$(this).bind("keyup change",function(){var e=t.find('input[name="mjd"]').val();check_form_input(/^[0-9\.]{5,12}$/,$(this),e,n,"mjd not in correct format yet")})});t.find("select#suggestedType").change(function(){if($(this).val()!="variable star"){t.find('input[name="hostRedshift"]').animate({opacity:1},300);t.find("div#host").animate({opacity:1},300)}else{t.find('input[name="hostRedshift"]').animate({opacity:0},300);t.find("div#host").animate({opacity:0},300)}});t.find('input[name="hostRedshift"]').focus(function(){$(this).bind("keyup change",function(){var e=t.find('input[name="hostRedshift"]').val();check_form_input(/^([0-9]\.[0-9]{1,7}$)|$^/,$(this),e,n,"redshift not in the correct format yet")})});t.find('input[name="createdBy"]').focus(function(){$(this).bind("keyup change",function(){var e=t.find('input[name="createdBy"]').val();check_form_input(/^.{2,50}/,$(this),e,n,"please enter more than 2 characters")})});var r=t.find("#formSubmitted");t.find("button#create").click(function(){event.preventDefault();var r=0,i="",s=t.find('input[name="objectName"]').val(),r=r+!/\w{6,100}/.test(s),i=i+"objectName="+s,o=t.find('input[name="survey"]').val(),r=r+!/\w{3,20}/.test(o),i=i+"&survey="+o,u=t.find('input[name="objectUrl"]').val(),a=/[-a-zA-Z0-9@:%_\+.~#?&//=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&//=]*)?|$^/gi,r=r+!a.test(u);u.length==0&&(u="NULL");var i=i+"&objectUrl="+u,f=t.find('input[name="objectImageUrl"]').val(),a=/[-a-zA-Z0-9@:%_\+.~#?&//=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&//=]*)?|$^/gi,r=r+!a.test(f);f.length==0&&(f="NULL");var i=i+"&objectImageUrl="+f,l=t.find('input[name="ra"]').val();l>360|l<0&&(r+=1);var r=r+!/^\d{1,3}\.\d{1,}/.test(l),i=i+"&ra="+l,c=t.find('input[name="dec"]').val();c>90|c<-90&&(r+=1);var r=r+!/^[\-\+]?\d{1,3}\.\d{1,}/.test(c),i=i+"&dec="+c,h=t.find('input[name="discoveryMag"]').val(),r=r+!/^\d{1,2}\.\d{1,3}/.test(h),i=i+"&discoveryMag="+h,p=t.find('input[name="discoveryFilter"]').val(),r=r+!/^\w{1,7}/.test(p),i=i+"&discoveryFilter="+p,d=t.find('input[name="mjd"]').val(),r=r+!/^[0-9\.]{5,12}$/.test(d),i=i+"&mjd="+d,v=t.find("select#suggestedType").val(),i=i+"&suggestedType="+v,m=t.find('input[name="hostRedshift"]').val(),i=i+"&hostRedshift="+m;if(v!="variable star")var r=r+!/^([0-9]\.[0-9]{1,5}$)|$^/.test(m);var g=t.find('input[name="createdBy"]').val(),r=r+!/^.{2,50}/.test(g),i=i+"&createdBy="+g,i="button=create_new_ticket&"+i;if(r==0){var y="../scripts/pesstoMarshallButtons.py?"+i;$.getJSON(y,function(e){});pause(20);e.slideToggle(200);t.fadeOut(400);var b=!0;return!0}event.preventDefault();n.css("color","#dc322f");n.text("there's an error in this form").show().fadeIn(300)})}function center(e){e.css("position","fixed");e.css("top","50px");e.css("left",Math.max(0,($(window).width()-e.outerWidth())/2+$(window).scrollLeft())+"px")}function add_object_comment(){event.preventDefault();var e=$(this).closest(".wfTableRow"),t=e.attr("poid"),n=e.find("#commentsHeader"),r=$(this).closest("form"),i=r.find('input[name*="author"]').val(),s=r.find('input[name*="comment"]').val();if(i.length<=3){r.find("#commentError").text("Author's name must be longer than 3 characters long.").show().fadeOut(5e3);return!1}if(s==""){r.find("#commentError").text("Please enter a comment").show().fadeOut(7e3);return!1}s=encodeURIComponent(s);var o='<div class="divVerticalKids" id="oneComment" style="height:0px; overflow:hidden; opacity:0;">'+s+'<div class="divHorizontalKids" id="commentFooter"> <span id="commentAuthor">'+i+', </span><span id="commentDate">just now</span></div><!-- /#commentFooter--></div>';$(o).insertAfter(n).animate({opacity:1},300);var u="../scripts/pesstoMarshallButtons.py?button=add_object_comment&pesstoObjectsId="+t+"&author="+i+"&comment="+s;alert(u);$.getJSON(u,function(e){});r.find('input[name*="author"]');r.find('input[name*="comment"]').val();r.slideUp(300);return!1}function hideRow(e,t){document.getElementById(e).className="wfTableRow_hide";jQuery.ajax({type:"POST",url:"../scripts/btnx_change_mwf_flag.py?pesstoObjectsId="+e+"&mwfFlag="+t})}function sortFormValidation(){$(this).keypress(function(e){(e.keyCode==10||e.keyCode==13)&&e.preventDefault()});var e=["peak abs mag","peak absolute magnitude","abs mag","absolute magnitude","z","distance","mpc","redshift","magnitude","mag","apparent magnitude","app mag","classification","class","spectral type","type","prediction","dec","ra","id","name","object id","identity","mjd","obs date","obsdate","last observed","recent obs","recent observation"];thisInput=$(this);defaultBackground=thisInput.css("background-color");defaultColour=thisInput.css("color");$(this).bind("keyup change",function(){match=0;sortValue=thisInput.val();for(var t=0;t<e.length;t++)sortValue==e[t]&&(match=1);if(sortValue.length==0)thisInput.removeAttr("style");else if(match==1){thisInput.css("background-color","#BEC989");thisInput.css("color","#073642")}else{thisInput.css("background-color","#D09B9D");thisInput.css("color","#073642")}thisInput.keyup(function(e){if((e.keyCode==10||e.keyCode==13)&&match==1){var t=$(location).attr("href");regExp=/(sortBy).*(&)/g;regExp2=/(sortBy)/g;regExp3=/(index.py)$/;if(regExp.test(t)){var n=t.replace(regExp,"sortBy="+sortValue+"&");window.location.href=n}else if(regExp2.test(t)){var n=t.replace(/(sortBy).*/,"sortBy="+sortValue);window.location.href=n}else if(regExp3.test(t)){var n=t+"?bi=inbox&sortBy="+sortValue;window.location.href=n}else{var n=t+"&sortBy="+sortValue;window.location.href=n}}})})}function searchFormValidation(){$(this).keypress(function(e){(e.keyCode==10||e.keyCode==13)&&e.preventDefault()});thisInput=$(this);thisInput.keyup(function(e){if(e.keyCode==10||e.keyCode==13){searchValue=thisInput.val();var t=window.location.pathname,n=t+"?bi=all&search="+searchValue;window.location.href=n}})}function moveObjectAndHideRow(e){var t=$(this).closest(".wfTableRow"),n=t.attr("poid"),e=$(this).attr("mwfFlag");$(t).animate({opacity:.25},150);$(t).delay(600).slideUp(300);jQuery.ajax({type:"POST",url:"../scripts/pesstoMarshallButtons.py?button=change_mwf_flag&pesstoObjectsId="+n+"&mwfFlag="+e})}function alertObjectAndHideRow(){var e=$(this).closest(".wfTableRow"),t=e.attr("poid"),n=$(this).attr("awfFlag"),r="../scripts/pesstoMarshallButtons.py?button=change_awf_flag&pesstoObjectsId="+t+"&awfFlag="+n;$(e).animate({opacity:.25},150);$(e).delay(600).slideUp(300);jQuery.ajax({type:"POST",url:"../scripts/pesstoMarshallButtons.py?button=change_awf_flag&pesstoObjectsId="+t+"&awfFlag="+n})}function revealDropDownMenu(){row=$(this).closest('div[id$="Menu"]');var e=row.find('div[class$="MenuButton"]');for(var t=0;t<e.length;t++)$(e[t]).slideDown(300)}function hideDropDownMenu(){var e=event.relatedtarget||event.toElement;while(e&&e!=this)e=e.parentNode;if(e!=this){row=$(this).closest('div[id$="Menu"]');var t=row.find('div[class$="MenuButton"]');for(var n=0;n<t.length;n++)$(t[n]).slideUp(300)}}function pause(e){var t=new Date,n=null;do n=new Date;while(n-t<e)}function check_form_input(e,t,n,r,i){r.css("color","#dc322f");if(!e.test(n)){r.text(i).show().fadeIn(300);t.css("background-color","#D09B9D");t.css("color","#073642");return!1}if(r!=null){var s=Math.random(),o="";s<.1?o="great":s<.2?o="lovely shoes":s<.3?o="nice":s<.4?o="sweet":s<.5?o="get a hair cut":s<.6?o="want fries with that?":s<.7?o="good job":s<.8?o="excellent":s<.9?o="thanks":o="you've done this before!";r.css("color","#859900");r.text(o).fadeOut(1e3);t.css("background-color","#BEC989");t.css("color","#073642");return!0}}function htmlEscape(e){e=encodeURIComponent(e);e=String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;");return e}window.addEventListener("load",doFirst,!1);